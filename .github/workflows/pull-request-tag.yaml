name: Test Chart Modifications

on:
  pull_request:
    branches:
      - main
      - develop
      - feature/**
  workflow_dispatch:

jobs:
  test-chart-modifications:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up yq and Helm (if required)
        run: |
          sudo snap install yq
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      - name: Read Chart.yaml
        id: read_chart
        run: |
          CHART_FOLDER="charts/project-origin-wallet" # Update this path to your chart's directory
          echo "CHART_PATH=${CHART_FOLDER}/Chart.yaml" >> $GITHUB_ENV
          echo "CHART_NAME=$(yq e '.name' $CHART_FOLDER/Chart.yaml)" >> $GITHUB_ENV
          echo "CURRENT_VERSION=$(yq e '.version' $CHART_FOLDER/Chart.yaml)" >> $GITHUB_ENV
          echo "::set-output name=chart_name::$(yq e '.name' $CHART_FOLDER/Chart.yaml)"
          echo "::set-output name=current_version::$(yq e '.version' $CHART_FOLDER/Chart.yaml)"

      - name: Print initial Chart.yaml content
        run: cat ${{ env.CHART_PATH }}

      - name: Simulate prerelease condition modification
        run: |
          # Simulate changing the prerelease condition based on a condition, e.g., a PR title or branch name
          PRERELEASE="false"
          if [[ "${{ github.head_ref }}" == feature/* ]]; then
            PRERELEASE="true"
          fi
          if [ "$PRERELEASE" = "true" ]; then
            yq e '.annotations["artifacthub.io/prerelease"] = "true"' -i ${{ env.CHART_PATH }}
          else
            yq e 'del(.annotations["artifacthub.io/prerelease"])' -i ${{ env.CHART_PATH }}
          fi

      - name: Print modified Chart.yaml content
        run: cat ${{ env.CHART_PATH }}

      - name: Upload modified Chart.yaml as artifact
        uses: actions/upload-artifact@v2
        with:
          name: Modified-Chart.yaml
          path: ${{ env.CHART_PATH }}
